<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù†Ø²Ù†! | Ø¨Ø§Ø²ÛŒ Ø³Ø±Ø¹Øª Ø¹Ù…Ù„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#020617">
  <style>
    body { background:#020617; }
    .neon-green { background:#16ff4f; box-shadow:0 0 25px #16ff4f, 0 0 50px #16ff4f; }
    .neon-red { background:#ff1645; box-shadow:0 0 25px #ff1645, 0 0 50px #ff1645; }
    .neon-yellow { background:#ffff3f; box-shadow:0 0 25px #ffff3f, 0 0 50px #ffff3f; color:#000; }
    .neon-btn { box-shadow:0 0 20px #3b82f6, 0 0 40px #3b82f6; }
  </style>
</head>
<body class="fixed inset-0 text-white select-none">

<div id="game" class="w-full h-full flex flex-col items-center justify-center text-center transition-all duration-200">

  <h1 class="text-3xl font-bold mb-2">ðŸŽ® Ù†Ø²Ù†!</h1>
  <div id="tutorial" class="bg-gray-800 bg-opacity-80 p-4 rounded-xl mb-4 max-w-sm">
    <p class="mb-1">Ø±Ø§Ù‡Ù†Ù…Ø§:</p>
    <ul class="list-disc list-inside text-left">
      <li>ðŸŸ¢ Ø³Ø¨Ø² â†’ Ø³Ø±ÛŒØ¹ Ø¨Ø²Ù†</li>
      <li>ðŸŸ¡ Ø²Ø±Ø¯ â†’ Ù†Ú¯Ù‡ Ø¯Ø§Ø±</li>
      <li>ðŸ”´ Ù‚Ø±Ù…Ø² â†’ Ù†Ø²Ù†</li>
    </ul>
    <button id="startBtn" class="mt-2 px-6 py-2 bg-blue-500 rounded-2xl neon-btn active:scale-95 transition">Ø´Ø±ÙˆØ¹ Ø¨Ø§Ø²ÛŒ</button>
  </div>

  <div class="mb-4 text-lg">
    Ø§Ù…ØªÛŒØ§Ø²: <span id="score">0</span>
    <span class="mx-2">|</span>
    Ø±Ú©ÙˆØ±Ø¯: <span id="best">0</span>
  </div>

</div>

<audio id="winSound" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
<audio id="loseSound" src="https://assets.mixkit.co/active_storage/sfx/2589/2589-preview.mp3"></audio>

<script>
let score = 0;
let color = "red"; // green, yellow, red
let interval = 1200;
let timer;
let holdStart = null;

const game = document.getElementById("game");
const scoreEl = document.getElementById("score");
const bestEl = document.getElementById("best");
const startBtn = document.getElementById("startBtn");
const tutorial = document.getElementById("tutorial");
const winSound = document.getElementById("winSound");
const loseSound = document.getElementById("loseSound");

let bestScore = localStorage.getItem("bestScore") || 0;
bestEl.textContent = bestScore;

function vibrate(ms=100){ navigator.vibrate?.(ms); }

function levelText(s){
  if(s<5) return "ðŸ¢ Ú©Ù†Ø¯";
  if(s<10) return "ðŸ§  Ù†Ø±Ù…Ø§Ù„";
  if(s<20) return "âš¡ Ø³Ø±ÛŒØ¹";
  return "ðŸ¥· Ù†ÛŒÙ†Ø¬Ø§";
}

function startGame(){
  score=0;
  interval=1200;
  scoreEl.textContent=score;
  tutorial.classList.add("hidden");
  nextRound();
}

function nextRound(){
  clearTimeout(timer);
  const rand = Math.random();
  if(rand<0.33) color="green";
  else if(rand<0.66) color="yellow";
  else color="red";

  game.className = "w-full h-full flex flex-col items-center justify-center text-center transition-all duration-200";
  if(color==="green") game.classList.add("neon-green");
  if(color==="red") game.classList.add("neon-red");
  if(color==="yellow") game.classList.add("neon-yellow");

  // Ú†Ø´Ù…Ú© Ø³Ø±ÛŒØ¹ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆÙ„ Ø²Ø¯Ù† (30% ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ø³Ø¨Ø²)
  if(color==="green" && Math.random()<0.3){
    setTimeout(()=>{
      game.classList.remove("neon-green");
      game.classList.add("neon-red");
      color="red";
    }, 150);
  }

  holdStart = null;

  timer = setTimeout(()=>{
    // Ø§Ú¯Ù‡ Ø±Ù†Ú¯ Ø³Ø¨Ø² Ø¨ÙˆØ¯ Ùˆ Ú©Ø§Ø±Ø¨Ø± Ù†Ø²Ø¯Ù‡ â†’ Ø¨Ø§Ø®Øª
    if(color==="green") gameOver();
    // Ø§Ú¯Ù‡ Ø±Ù†Ú¯ Ø²Ø±Ø¯ Ø¨ÙˆØ¯ Ùˆ Ù†Ú¯Ù‡ Ù†Ø¯Ø§Ø´Øª â†’ Ø¨Ø§Ø®Øª
    if(color==="yellow" && holdStart===null) gameOver();
    else nextRound();
  }, interval);

  interval = Math.max(400, interval-30);
}

function gameOver(){
  clearTimeout(timer);
  game.className = "w-full h-full flex flex-col items-center justify-center text-center transition-all duration-200";
  game.style.background="#020617";
  vibrate(300);
  loseSound.play();

  if(score>bestScore){
    bestScore=score;
    localStorage.setItem("bestScore", bestScore);
    bestEl.textContent=bestScore;
  }

  alert(`ðŸ’€ Ø¨Ø§Ø®ØªÛŒ!\nØ§Ù…ØªÛŒØ§Ø²: ${score}\nØ³Ø·Ø­: ${levelText(score)}`);
  tutorial.classList.remove("hidden");
}

game.addEventListener("mousedown", handleClick);
game.addEventListener("touchstart", handleClick);

game.addEventListener("mouseup", handleRelease);
game.addEventListener("touchend", handleRelease);

function handleClick(e){
  if(tutorial.classList.contains("hidden")===false) return;

  if(color==="green"){
    score++; scoreEl.textContent=score; winSound.play(); clearTimeout(timer); nextRound();
  } else if(color==="yellow"){
    holdStart = Date.now();
  } else if(color==="red"){
    gameOver();
  }
}

function handleRelease(e){
  if(color==="yellow" && holdStart){
    const holdTime = Date.now() - holdStart;
    // Ø§Ú¯Ø± Ú©Ù…ØªØ± Ø§Ø² 500ms Ù†Ú¯Ù‡ Ø¯Ø§Ø´Øª â†’ Ø¨Ø§Ø®Øª
    if(holdTime<500){
      gameOver();
    } else {
      score++; scoreEl.textContent=score; winSound.play(); clearTimeout(timer); nextRound();
    }
    holdStart=null;
  }
}

startBtn.onclick=startGame;

// Service Worker PWA
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>

</body>
</html>
